<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>haxx qua non - Rails logged_in_user idiom</title>
  <meta name="description" content="tips and tricks from a working coder">
  <link rel="stylesheet" type="text/css" href="/css/site.css" />
</head>
<body>

  <header>
    <h1>
      <a class="header-span plain" rel="home" href="http://haxx.sinequanon.net/">haxx qua non</a>
    </h1>
  </header>

  <article>

      <h1>Rails logged_in_user idiom</h1>

      <section id="meta">

          <div id="byline">
            by jja
            on <time datetime="2008-10-07T12:04:21-0600">2008-10-07</time>
          </div>

          Topics: <ul id="tags">
              <li class="tagitem">
                <a class="tag" href="/tag/rails">rails</a>
              </li>
          </ul>

      </section>

      <section id="post_content">

        <p>I recently refactored another developer&#39;s code to clean up some massive
amounts of database pings to retrieve the current user object. The main
problem was in the use of the logged_in_user or current_user idiom in Rails.
<a href="http://books.google.com/books?id=2NZG4ASmnZ0C&amp;pg=PA54&amp;lpg=PA54&amp;dq=rails+logged_in_user&amp;source=web&amp;ots=x7Hqg6pZw7&amp;sig=N2itAovNoEyoIwzDO42GmeRLco0&amp;hl=en&amp;sa=X&amp;oi=book_result&amp;resnum=7&amp;ct=result">Several</a>
<a href="http://railscasts.com/episodes/1">places</a>
<a href="http://almosteffortless.com/2008/01/07/simplifying-and-sharing-code-with-rails-conventions/">give</a>
<a href="http://www.freezzo.com/2008/08/22/session-current-user-object-bad/">good</a>
<a href="http://snippets.dzone.com/posts/show/4922">examples</a>
but leave out the details that were bugging my project.</p>
<!-- more -->
<h2 id="user-id">user.id</h2>
<p>Firstly, don&#39;t store the
<a href="http://www.freezzo.com/2008/08/22/session-current-user-object-bad/">user object</a>
in the session! Just store the user object&#39;s ID. In <code>LoginController#login</code>, use:</p>
<pre><code>        session[:user_id] = user.id
</code></pre><p>(full method below).</p>
<h2 id="caching-helper_method">caching helper_method</h2>
<p>Rather than a before filter on ApplicationController, I used a helper method
logged_in_user:</p>
<pre><code>class ApplicationController &lt; ActionController::Base
  helper_method :logged_in_user
  private
  def logged_in_user
    return (@logged_in_user=nil) if session[:user_id].nil?
    @logged_in_user ||= User.find_by_id(session[:user_id])
  end
  def reset_logged_in_user
    @logged_in_user=nil
  end
#...
end
</code></pre><p>The method returns the
<a href="http://railstips.org/2006/11/18/class-and-instance-variables-in-ruby">instance variable</a>
of the same name (<code>@logged_in_user</code>). If the variable is not already set, only
then does the method use find_by_id to load the object from the database
(saving an extra database ping over other examples). An
<a href="http://railscasts.com/episodes/1">instance variable</a>
is scoped to the instance of
ApplicationController, i.e. it exists for the duration of the web request.
Thus it acts as a cache during the request. We can then call logged_in_user
from our views without repeatedly accessing the database:</p>
<pre><code>&lt;% if logged_in_user %&gt;
</code></pre><p>and we can access any User methods like this:</p>
<pre><code>&lt;% if logged_in_user and logged_in_user.may_view_all? %&gt;
</code></pre><h2 id="security">security</h2>
<p>For security, be sure your LoginController resets both the user ID in the
session and the logged_in_user instance variable:</p>
<pre><code>class LoginController &lt; ApplicationController
#...
  def login
    session[:user_id] = nil
    reset_logged_in_user
    if request.post?
      user = User.authenticate(params[:username], params[:password])
      if user
        session[:user_id] = user.id
        redirect_to(:action =&gt; &quot;index&quot;)
      else
        flash[:notice] = &quot;Invalid user/password combination&quot;
        params[:password]=nil
      end
    end
  end
  def logout
    session[:user_id] = nil
    reset_logged_in_user
    reset_session
    flash[:notice] = &quot;Logged out&quot;
    redirect_to(:action =&gt; &quot;login&quot;)
  end
end
</code></pre><h2 id="alternatives">alternatives</h2>
<p>Here are two other ways of writing logged_in_user that show the logic a little
more clearly, if more verbose:</p>
<pre><code>def logged_in_user
    @logged_in_user = User.find_by_id(session[:user_id]) if
      @logged_in_user.nil? and session[:user_id]
    @logged_in_user
end

def logged_in_user
    if session[:user_id].nil?
      @logged_in_user=nil
    elsif @logged_in_user.nil?
      @logged_in_user = User.find_by_id(session[:user_id])
    end
    @logged_in_user
end
</code></pre><h2 id="applicationhelper">ApplicationHelper</h2>
<p>Final tip: make sure you don&#39;t put a logged_in_user helper method on
ApplicationHelper--- that&#39;s how our app was pinging the database for the user
object tens of times per page view as this method was getting used instead of
ApplicationController&#39;s!</p>


      </section>

  </article>

  <div id="comment-form">
        (comments are closed)
  </div>

  <section id="nav">
        <a class="footer-span plain" href="/2009/03/less-sudo-and-devnull-permission-denied">Previous: less, sudo, and /dev/null: Permission denied</a>

        <a class="footer-span plain" href="/2008/10/grails-errorgsp-security">Next: Grails error.gsp security</a>
  </section>

  <footer>
    <a class="footer-span plain" rel="home" href="http://haxx.sinequanon.net/">Home</a>
  </footer>

</body>
</html>
